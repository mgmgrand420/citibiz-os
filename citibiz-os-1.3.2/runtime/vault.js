export async function encryptJSON(obj,password){const salt=crypto.getRandomValues(new Uint8Array(16));const iv=crypto.getRandomValues(new Uint8Array(12));const enc=new TextEncoder();const km=await crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveKey']);const key=await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:310000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);const pt=enc.encode(JSON.stringify(obj));const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},key,pt));return JSON.stringify({v:1,alg:'AES-256-GCM',kdf:'PBKDF2-SHA256-310k',salt:Array.from(salt),iv:Array.from(iv),ct:Array.from(ct)});} export async function decryptJSON(json,password){const blob=JSON.parse(json);const salt=new Uint8Array(blob.salt),iv=new Uint8Array(blob.iv),ct=new Uint8Array(blob.ct);const enc=new TextEncoder();const km=await crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveKey']);const key=await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:310000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,ct);return JSON.parse(new TextDecoder().decode(new Uint8Array(pt)));} export const Vault={state:{id:null,createdAt:null,data:{}},async create(p){const id='vault_'+Math.random().toString(36).slice(2,10);const payload={id,createdAt:Date.now(),data:{profile:{},posts:[],settings:{}}};const j=await encryptJSON(payload,p);localStorage.setItem('vault',j);document.cookie=`session=${id}; Path=/; SameSite=Lax`;this.state=payload;return payload;},async import(txt,p){const data=await decryptJSON(txt,p);localStorage.setItem('vault',txt);document.cookie=`session=${data.id}; Path=/; SameSite=Lax`;this.state=data;return data;},async write(path,value){const cur=this.state;const seg=path.split('.');let o=cur;for(let i=0;i<seg.length-1;i++){const k=seg[i];o[k]=o[k]??{};o=o[k];}o[seg[seg.length-1]]=value;const j=await encryptJSON(cur,'relock:'+cur.id);localStorage.setItem('vault',j);return cur;}};